<!DOCTYPE html>
<html>
<head>
  <title>math.js | plot</title>
  <script src="dependencies/math.js"></script> 
  <script src="dependencies/d3.min.js"></script>
  <script src="dependencies/FFT.js"></script>
  <script src="dependencies/function-plot.js"></script>
  <script src="src/waves.js"></script>

  <style>
    input[type=text] {
      width: 300px;
    }
    input {
      padding: 6px;
    }
    body, html, input {
      font-family: sans-serif;
      font-size: 11pt;

    }
    form {
      margin: 20px 0;
    }
  </style>
</head>
<body>

<form id="form">
  <label for="eq">Enter an equation:</label>
  <input type="text" id="eq" value="atan(3*cos(x*2500) + 2*sin(x*1000))" />
  <input type="submit" value="Draw" />
</form>

<div id="plot"></div>
<div><canvas id="fft" width="1000" height="200"></canvas></div>

<script>
var rate = 48000;
  var dt = 1/rate;
  var num_samples = 0.1/dt;
  var bars = document.getElementById('fft'),
      ctx = bars.getContext('2d'),
      fft = new FFT(num_samples, rate);
  
  bars.width = screen.width;

  function draw() {
    try {
      var data = []
      var x = 0;
      var fn = document.getElementById('eq').value;
      var n = 0;
      while (n < num_samples){
        data.push([x,math.eval(fn, {x:x*2*Math.PI})]);
        x+=dt;
        n += 1;
      }
      var ws= waves(data)

      functionPlot({
        target: '#plot',
        width: screen.width,
        height: screen.width/5,
        xDomain: [0,0.1],
        yDomain: [-2,2],
        data: [{
          range: [0,0.1],
          fnType: 'points',
          graphType: 'polyline',
          points: data
        },
        {
          range: [0,0.1],
          fnType: 'points',
          graphType: 'polyline',
          points: ws
        }]
      });

      var signal = new Float32Array(num_samples);
      for (var i = 0; i < num_samples; i++ ) {
        signal[i] = ws[i][1]
      }
      fft.forward(signal)
      var s = fft.spectrum

      // Clear the canvas before drawing spectrum
      ctx.clearRect(0,0, bars.width, bars.height);
      var sample_steps = 1;
      var bucket_size = 10;
      var scale = bars.width/(num_samples/2);
      for (var i = 0; i + bucket_size < 4800; i+=sample_steps ) {
        var magnitude = 0;
        for (var j = 0; j <= bucket_size; j++, i++) {
          magnitude += s[i]*s[i];
        };
        // multiply spectrum by a zoom value
        
        // Draw rectangle bars for each frequency bin
        ctx.fillRect(scale*i/sample_steps, bars.height, sample_steps*bucket_size*scale, -Math.log(1+Math.sqrt(magnitude)/bucket_size)*1000);
      }

    }
    catch (err) {
      console.log(err);
      alert(err);
    }
  }

  document.getElementById('form').onsubmit = function (event) {
    event.preventDefault();
    draw();
  };

  draw();
</script>

</body>
</html>